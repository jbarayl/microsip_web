{% extends "inventarios/base.html" %}
{% block title %}Inventario fisico{% endblock %}

<!-- CSS Code -->
{% block style_css %}
<link rel='stylesheet' href='{{STATIC_URL}}css/inventarios.css'/>
{% endblock %}

<!-- JavaScript Code -->
{% block js_code %}
<script type="text/javascript">
function limpiarForm()
{
  $("#id_unidades, #id_claveArticulo, #id_articulo_text").val('');
  $("#span_alerta_unidades").html("");
  $("#buscar_btn, .span_clave").show();
  $(".span_unidades, #cancelar_btn").hide();
  if ($("#chbx_modorapido").is(':checked'))
  {
    $(".span_articulo, #span_nombre_articulo").hide();
    $(".span_clave").show();
    $("#id_claveArticulo").focus();
  }
  else
  {
    if ( $("#id_articulo-deck").children().length != 0) 
      deselecionarArticulo();

    $(".span_clave").hide();
    $(".span_articulo, #id_articulo_text, #span_nombre_articulo").show();
    $("#id_articulo-text").focus();
  }
}

function load_localstorage()
{
  modo_rapido = localStorage.getItem("modo_rapido");
  if (modo_rapido == null)
    localStorage.setItem("modo_rapido", 'false');
  
  if(localStorage.getItem("modo_rapido") == 'true')
    $("#id_clave").focus();
  else
  {
    $("#id_articulo_text").focus();
    $("#chbx_modorapido").attr('checked', true);
  }

  $('#id_clave').focusin(function(){
    if (localStorage.getItem("modo_rapido") == 'false')
      localStorage.setItem("modo_rapido", 'true');
  });

  $('#id_articulo_text').focusin(function(){
    if (localStorage.getItem("modo_rapido") == 'true')
      localStorage.setItem("modo_rapido", 'false');
  });

  ubicacion = localStorage.getItem("ubicacion");
  if (ubicacion == null)
    localStorage.setItem("ubicacion", '');
  
  $("#id_ubicacion").val(localStorage.getItem("ubicacion"));
  $("#id_ubicacion").change(function() {
    localStorage.setItem("ubicacion",$("#id_ubicacion").val());
  });
}

function buscar_articulo(){
  //if($(".span_articulo").is(":hidden"))
  //{
  if($("#id_claveArticulo").val() != '')
    Dajaxice.microsip_web.apps.inventarios.get_existenciasarticulo_byclave(cargar_art,{'articulo_clave': $('#id_claveArticulo').val(), 'almacen': $("#almacen_nombre").val(), });
  else
    $("#id_claveArticulo").focus();
  //}
  //else
  //{
    //Dajaxice.microsip_web.apps.inventarios.get_articulosen_inventario(mostrar_unidades,{'inventario_id': {{ InventarioFisico.id }},'articulo_id':$('#id_articulo option:selected').val()});    
  //}

}

function cargar_art(data)
{
  if (data.error_msg == "no_existe_clave")
  {
    var opciones = data.opciones_clave
    var html_var = "<table><tr><th>Clave</th><th>Articulo</td><tr/>"
    var no_opciones = 0
    for (art in opciones)
    { 
      no_opciones = no_opciones +  1;
      html_var = html_var + "<tr><td><a href='#' class='clave_link'>" + art + "</a></td>" + "<td>" + opciones[art] + "</td></tr>"
    }
    html_var = html_var + "</table>"
    if (no_opciones > 0)
    {
      $("#modal_opciones-claves > .modal-body").html(html_var);
      $(".clave_link").on("click",function(){
        $("#id_claveArticulo").val($(this).text());
        $("#modal_opciones-claves").modal("hide");
        Dajaxice.microsip_web.apps.inventarios.get_existenciasarticulo_byclave(cargar_art,{'articulo_clave': $('#id_claveArticulo').val(), 'almacen': $("#almacen_nombre").val(), });
      });

      $("#modal_opciones-claves").modal();
    }
    else
      alert('No existe ningun articulo con la clave ['+ $("#id_claveArticulo").val() +']');
  } 
  else
  {
    cargar_articulo( data.articulo_id, data.articulo_nombre, data.existencias, data.costo_ultima_compra  );
  }
}

function cargar_articulo( articulo_id, articulo_nombre, existencias, costo_ultima_compra )
{
  $('#id_articulo-deck').attr('style','');
  $('#id_articulo-deck').html('<span class="div hilight" data-value="'+articulo_id+'"><span style="display: inline;" class="remove div">X</span>'+articulo_nombre+'</span>');
  $('#id_articulo').html('<option selected="selected" value="'+articulo_id+'"></option>');
  $('#id_articulo_text').hide();
  $('#span_alerta_unidades').html(existencias + ' en existencia.');
  $("#id_costo_unitario").val(costo_ultima_compra);

  $(".remove").on('click', function(){
    $('#span_alerta_unidades').html('');
    $("#id_unidades").val('');
    $(".span_clave").show();
    $(".span_articulo").hide();
    
    $("#id_claveArticulo").val(""); 
    if(localStorage.getItem("modo_rapido") == 'true')
      $("#id_claveArticulo").focus();
    else
      $("#id_articulo_text").focus();
  });

  $("#id_unidades").focus();
  alert( existencias + " Articulos en existencia" );

}

$(document).ready(function(){
  
  $("#id_articulo_text").before("<span class='add-on' id='span_nombre_articulo'>Nombre</span>")

  if (Modernizr.localstorage) 
  {
    /* LOCAL STORAGE */
    load_localstorage();
  }
  else
    $("#chbx_modorapido").attr('checked', true);
    
  limpiarForm();
});

</script>
{% endblock %}

{% block breadcrumb %}{% endblock %}
{% block content %}
<div id="modal_opciones-claves" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3 id="myModalLabel">Claves</h3>
  </div>
  <div class="modal-body">
  </div>
</div>
<form method="post" class="form-horizontal" action="#">
  <input type="hidden" id ="id_seguimiento" name="seguimiento" value="">
  <div class="ms-custom-form collapse">
    <div>
      <div class='span all_screen' >
        <label class="small_screen"> Ubicacion</label> 
        <input class="input-small" id="id_ubicacion" name="ubicacion" placeholder="Ubicacion.." type="text">  
        <input type="checkbox" id="chbx_modorapido" value="ham" onclick="" /><div class="small_screen" style="font-size: .8em;">Rapido</div>
      </div>
    </div>
  </div>
  <div id="span_details" class="small_screen_block">
    <button type="button" class="btn btn-mini btn-navbar" data-toggle="collapse"  data-target=".ms-custom-form">
      <i class="icon-arrow-down"></i>
    </button>
  </div>
  {% csrf_token %}
   
  {{ form.errors }}

  <div class="span span_clave" >
    <div class="input-prepend input-append">
      <span class="add-on ">Clave</span>
      {{ form.claveArticulo }}
    </div>
  </div>
  <div class="span span_articulo" >
    <div class="input-prepend input-append">
      {{ form.articulo }}
    </div>
    <span id='span_alerta_unidades' class="text-error" style=" background-color: rgb(255, 0, 0); color: white;"> </span>
  </div>
  <a id="buscar_btn" class= "btn btn-primary span12 " href="#" onclick="buscar_articulo()" ><i class="icon-search icon-white"></i> <br>Buscar</a>
  <div class="span1 span_unidades" >
    <div class="input-prepend input-append">
      {{ form.unidades }}
      <a class="btn btn-success " id="enviar_btn" onclick="enviar_unidades();" href="#">Enviar</a>
    </div>
  </div>
  <br>
  <a id="cancelar_btn" class= "btn btn-danger span12 " href="#" onclick="limpiarForm();" >Cancelar</a>
  <br style='clear:both;'>
  <input type="hidden" id="almacen_nombre" value="{{ almacen.nombre }}"/>
</form>

{% endblock %}