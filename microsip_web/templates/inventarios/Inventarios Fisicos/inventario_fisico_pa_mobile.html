{% extends "inventarios/base.html" %}
{% block title %}INV. {{ InventarioFisico.folio}} ({{ InventarioFisico.almacen}}){% endblock %}

<!-- CSS Code -->
{% block style_css %}{% endblock %}

<!-- JavaScript Code -->
{% block js_code %}
{% include 'autocomplete_light/static.html' %}      
<link rel='stylesheet' href='{{STATIC_URL}}css/inventarios.css'/>
<script type="text/javascript">   
  function myJsFunc()
  {
    if($("#id_clave").val() != '')
    {
      Dajaxice.microsip_web.apps.inventarios.get_articulo_by_clave(mostrar_articulo,{'clave': $('#id_clave').val(),});
      $("#id_unidades").val('');
      $('#label_articulo').html('');
      $("#id_unidades").show();
      $("#id_unidades").val('');
      $("#id_unidades").focus();
    }
    else
      $("#id_articulo_text").focus();
    return false
  }

  function enviar_unidades()
  {
    Dajaxice.microsip_web.apps.inventarios.add_aticulosinventario(limpiarForm, {'inventario_id': {{ InventarioFisico.id }},'articulo_id':$('#id_articulo option:selected').val(),'unidades':$('#id_unidades').val(),});
  }

  function limpiarForm()
  {
      $('#span_alerta_unidades').html('');
      $("#id_unidades").val('');
      $(".span_clave").show();
      $("#id_clave").val('');

      $('#id_articulo-deck').html('');
      $('#id_articulo').html('');
      $("#id_clave").focus();
  }
  $(document).ready(function(){
    $("#id_articulo_text").hide();
    $("#id_ubicacion").val("estante1");
    
    $('#id_clave').focus();
    $('#id_unidades, #id_articulo_text').focus(function() { 
      setTimeout(function(){
        window.scrollTo(0, 3);
      }, 0);  
    });

    modo_rapido = localStorage.getItem("modo_rapido");
    if (modo_rapido == null)
      localStorage.setItem("modo_rapido", 'false');
    
    if(localStorage.getItem("modo_rapido") == 'true')
      $("#id_clave").focus();
    else
      $("#id_articulo_text").focus();

    $('#id_clave').focusin(function(){
      if (localStorage.getItem("modo_rapido") == 'false')
        localStorage.setItem("modo_rapido", 'true');
    });

    $('#id_articulo_text').focusin(function(){
      if (localStorage.getItem("modo_rapido") == 'true')
        localStorage.setItem("modo_rapido", 'false');
    });

    ubicacion = localStorage.getItem("ubicacion");
    if (ubicacion == null)
      localStorage.setItem("ubicacion", '');
    $("#id_ubicacion").val(localStorage.getItem("ubicacion"));
    $("#id_ubicacion").change(function() {
      localStorage.setItem("ubicacion",$("#id_ubicacion").val());
    });



    $('#id_clave').live('keydown', function(e) { 
      var keyCode = e.keyCode || e.which; 

      if (keyCode == 13 || keyCode == 9) 
      { 
        if($("#id_clave").val() != '')
          Dajaxice.microsip_web.apps.inventarios.get_articulo_by_clave(mostrar_articulo,{'clave': $('#id_clave').val(),});
        else
          $("#id_articulo_text").focus();
        return false
      }

    });

    
     // $('#enviar_btn').click(function(){
     //    
     // });

    $("#id_articulo").change(function(){
      if ($("#id_articulo").children().length > 0)
        Dajaxice.microsip_web.apps.inventarios.get_articulosen_inventario(mostrar_unidades,{'inventario_id': {{ InventarioFisico.id }},'articulo_id':$('#id_articulo option:selected').val()});
      else
        $('#span_alerta_unidades').html('');
    });
    
    $("#id_clave").live('mouseup', function () {
      $(this).select();
    });



    $('#btnCancel').on('click', function () {
      $("#myModal input").val()='';
    });

    $('#myModal').on('shown', function () {
      $("#myModal input").first().focus();
        alert ('ya'+$("#myModal input").first().vlaue());
    });

    
    {% if formset.total_form_count > 0 %} 
      
      if ($('form > .errorlist').length == 0)
        $('#myModal').modal();
        $("#myModal input").first().focus();
    {% endif %}
  });

  function mostrar_articulo(data){
    if (data.articulo_id != 0)
    {
      $('#id_articulo-deck').attr('style','');
      $('#id_articulo-deck').html('<span class="div hilight" data-value="'+data.articulo_id+'"><span style="display: inline;" class="remove div">X</span>'+data.articulo_nombre+'</span>');
      $('#id_articulo').html('<option selected="selected" value="'+data.articulo_id+'"></option>');
      $('#id_articulo_text').hide();

      Dajaxice.microsip_web.apps.inventarios.get_articulosen_inventario(mostrar_unidades,{'inventario_id': {{ InventarioFisico.id }},'articulo_id':$('#id_articulo option:selected').val()});
    }
     else
    {

      $('#id_articulo_text').attr('style','');
      $('#id_articulo-deck').html('');
      $('#id_articulo').html('');
      $('#id_articulo_text').show(); 
      alert('No existe ningun articulo con la clave ['+ $("#id_clave").val() +']');
      $("#id_clave").focus();
      $("#id_clave").select();

    }
  }


  function mostrar_unidades(data) 
  {
    if (data.unidades > 0 )
    {
      $('#span_alerta_unidades').html(' Ya existen '+ data.unidades + ' en inventario.');
      alert(' Ya existen '+ data.unidades + ' en inventario.\n Detalles:\n '+ data.detalle_modificaciones );
    }
    else
      $('#span_alerta_unidades').html('');

    $(".remove").on('click', function(){
      $('#span_alerta_unidades').html('');
      $("#id_unidades").val('');
      $(".span_clave").show();
      $("#id_unidades").focus();
    });

    $(".span_clave").hide();
    $("#id_unidades").val('');
    $("#id_unidades").focus();
  }

</script>



{% endblock %}
{% block breadcrumb %}<span class="big_screen"> {{ block.super }} <a href="/inventarios/InventariosFisicos/">Inventarios Fisico</a> <i class=" icon-play"></i>Inventario Fisico a apuerta abierta </span>{% endblock %}
{% block content %}
<form method="post" class="form-horizontal" action="" width="300px"  enctype='multipart/form-data'>
  {% if message %}
  <div class="alert alert-block alert-error fade in">
    <button type="button" class="close" data-dismiss="alert">Ã—</button>
    <h4 class="alert-heading">Oh NO! Ocurio un error!</h4>
    <p>{{ message }}</p>
  </div>
  {% endif %}
  <div class="ms-custom-form collapse">
    <div style='clear:both;'>
      <div class='span all_screen' >
        <label class="small_screen"> Ubicacion</label> {{ ubicacion_form.ubicacion }}  <input type = "checkbox" id = "chkHam" value = "ham" /><div style="
    display: inline-block;
    font-size: .8em;
">Rapido</div>
      </div>  
    </div>
  </div>
  <div id="span_details" class="small_screen_block">
    <button type="button" class="btn btn-mini btn-navbar" data-toggle="collapse"  data-target=".ms-custom-form">
      <i class="icon-arrow-down"></i>
    </button>
  </div>
  {% csrf_token %}
  {{ ubicacion_form.errors }}  
  {{ detalleInvForm.errors }}
  <div class="span span_clave" >
    <div class="input-prepend input-append">
      <span class="add-on small_screen">#</span>
      {{ detalleInvForm.clave }}
      <a id"buscar_btn" class= "btn small_screen" href="#" onclick="myJsFunc();" > <i class="icon-search"></i></a>
    </div>
  </div>
  <div class="span" >
    <div class="input-prepend input-append">
      {{ detalleInvForm.articulo }}
      <span id='span_alerta_unidades' class="text-error" style=" background-color: rgb(255, 0, 0); color: white;"> </span>
    </div>
  </div>
  <div class="span1" >
    <div class="input-prepend input-append">
      {{ detalleInvForm.unidades }}
      <a class="btn" id="enviar_btn" onclick="enviar_unidades();" href="#">Enviar</a>
      <!-- <button type="submit"  class="btn" onclick="this.disabled=true,this.form.submit(), this.value='Enviando...';" id='btn_submit_articulos' name='add_button'>Enviar</button> -->
    </div>
  </div>
  
</form>

{% endblock %}